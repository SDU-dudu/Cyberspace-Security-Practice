# 推导文档

## 一、泄露 `k` 导致泄露 `d1`

当 `k` 泄露时，攻击者可以利用 `k` 和签名值 `(r, s)` 来计算出私钥 `d1`：

1. 签名值为：
   $r = e + x_1 \mod n$，
   $s = \frac{1 + d_A^{-1} \cdot k - r \cdot d_A}{d_A} \mod n$

2. 已知 `k`、`r`、`s` 和 `e`，可以通过以下步骤计算出私钥 `d_A`：
   $d_A = \frac{k - s}{s + r} \mod n$

## 二、重用 `k` 导致泄露 `d1`

当对不同的消息使用相同的 `k` 进行签名时，攻击者可以通过两个签名值 `(r1, s1)` 和 `(r2, s2)` 来计算出私钥 `d1`：

1. 签名值为：

   $r_1 = e_1 + x_1 \mod n$

   $s_1 = \frac{1 + d_A^{-1} \cdot k - r_1 \cdot d_A}{d_A} \mod n$

   $r_2 = e_2 + x_1 \mod n$

   $s_2 = \frac{1 + d_A^{-1} \cdot k - r_2 \cdot d_A}{d_A} \mod n$

2. 从 `s1` 和 `s2` 的表达式出发：

   $s_1 = \frac{1 + k - r_1 \cdot d_A}{d_A} \mod n$

   $s_2 = \frac{1 + k - r_2 \cdot d_A}{d_A} \mod n$

3. 解方程组得到 `d_A`：
   $d_A = \frac{s_2 - s_1}{s_1 - s_2 + r_1 - r_2} \mod n$

## 三、两用户利用 `k`，推测彼此私钥 `d`

当两个用户对不同的消息使用相同的 `k` 进行签名时，攻击者可以通过两个签名值 `(r1, s1)` 和 `(r2, s2)` 来计算出彼此的私钥：

1. 签名值为：

   $r_1 = e_1 + x_1 \mod n$

   $s_1 = \frac{1 + d_{A}^{-1} \cdot k - r_1 \cdot d_{A}}{d_{A}} \mod n$

   $r_2 = e_2 + x_1 \mod n$

   $s_2 = \frac{1 + d_{B}^{-1} \cdot k - r_2 \cdot d_{B}}{d_{B}} \mod n$

2. 由于 `k` 相同，`r1` 和 `r2` 应该相等。攻击者可以利用以下公式恢复 `k`：
   $k = \frac{e_1 - e_2}{s_1 - s_2} \mod n$

3. 使用恢复的 `k` 计算出对方的私钥：
   $d_{A} = \frac{k \cdot s_2 - e_2}{r \cdot s_2} \mod n$
   $d_{B} = \frac{k \cdot s_1 - e_1}{r \cdot s_1} \mod n$

## 四、使用相同的 `d` 和 `k` 会导致泄露 `d1`

当使用相同的 `d` 和 `k` 进行 ECDSA 和 Schnorr 签名时，攻击者可以通过两个签名值来计算出私钥 `d`：

1. ECDSA 签名值为：
   $r_{ECDSA} = r$，
   $s_{ECDSA} = s$

2. Schnorr 签名值为：
   $r_{Schnorr} = r$，
   $s_{Schnorr} = k + e \cdot d \mod n$

3. 通过以下公式计算出私钥 `d`：
   $d = \frac{s_{Schnorr} \cdot s_{ECDSA} - e_{ECDSA}}{r_{ECDSA} + e_{Schnorr} \cdot s_{ECDSA}} \mod n$

