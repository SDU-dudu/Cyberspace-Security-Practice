# 实验六 Google Password Checkup 协议实现

## 一、实验目标
实现 Google Password Checkup 协议

协议允许用户和服务器在保护隐私的前提下，计算出用户密码集合与服务器泄露密码集合的交集大小以及交集中密码对应标签的总和。

通过实现该协议，深入理解安全多方计算（MPC）在实际应用场景中的应用，掌握 Diffie-Hellman 密钥交换、Paillier 同态加密等密码学技术的实现与应用。

## 二、实验内容与实现
### 2.1 协议流程

#### （一）初始化
- 用户类（`User`）和服务器类（`Server`）分别初始化。用户类持有自己的密码集合（`pwd_list`），服务器类持有泄露的密码集合及其对应的标签（`leak_pwd_tags`）。

#### （二）服务器生成公共参数
1. 服务器生成安全素数 `p` 和 `q`，满足 `p = 2q + 1`。
2. 生成群生成元 `g`。
3. 生成 Paillier 密钥对（公钥 `pub_key` 和私钥 `priv_key`）。
4. 服务器将生成的公共参数（`p`、`q`、`g` 和 `pub_key`）发送给用户。

#### （三）第 1 轮（用户）
1. 用户收到公共参数后，选择自己的私钥 `k1`。
2. 对自己的每个密码进行哈希运算，并使用 `k1` 进行加密，生成加密后的密码列表（`enc_pwd_list`）。
3. 将加密后的密码列表打乱顺序，发送给服务器。

#### （四）第 2 轮（服务器）
1. 服务器收到用户发送的加密密码列表后，选择自己的私钥 `k2`。
2. 对加密密码列表中的每个元素使用 `k2` 进行加密，生成新的加密密码列表（`enc_srv_pwd_list`），并打乱顺序。
3. 对服务器持有的每个泄露密码及其标签，计算密码的哈希值并使用 `k2` 加密，同时使用 Paillier 公钥对标签进行加密，生成带标签的加密密码列表（`srv_pwd_with_tags`）。
4. 服务器将 `enc_srv_pwd_list` 和 `srv_pwd_with_tags` 发送给用户。

#### （五）第 3 轮（用户）
1. 用户收到服务器发送的 `enc_srv_pwd_list` 和 `srv_pwd_with_tags` 后，对 `srv_pwd_with_tags` 中的每个元素使用 `k1` 进行加密，计算出 `H(w_j)^(k1*k2)`。
2. 确定哪些加密后的密码在 `enc_srv_pwd_list` 中，即找到交集元素。
3. 对交集元素对应的加密标签进行同态求和，得到加密的交集标签总和（`enc_sum`）。
4. 用户将加密的交集标签总和发送给服务器。

#### （六）结果解密（服务器）
服务器使用自己的私钥（`priv_key`）对收到的加密交集标签总和进行解密，得到最终的交集标签总和（`intersection_sum`）。

### 2.2 代码实现中的关键函数与参数对应关系

在代码实现中对应关系如下

- **`User` 类**：
  - `pwd_list`：用户持有的密码集合。
  - `k1`：用户的私钥。
  - `enc_pwd_list`：用户生成的加密并打乱后的密码列表。
  - `enc_sum`：用户计算的交集元素标签的加密和。

- **`Server` 类**：
  - `leak_pwd_tags`：服务器持有的泄露密码集合及其标签。
  - `k2`：服务器的私钥。
  - `enc_srv_pwd_list`：服务器生成的加密密码列表。
  - `srv_pwd_with_tags`：服务器生成的带标签的加密密码列表。
  - `intersection_sum`：服务器解密得到的交集标签总和。


## 三、实验结果与分析
### 3.1 实验结果
运行上述代码后，输出如下：

```
User's passwords: ['password1', 'password2', 'password3', 'password4']
Leaked passwords with tags: [('password1', 1), ('password3', 3), ('password4', 4), ('password6', 6)]
Sum of tags for intersected passwords: 8
```
<img src=".\运行结果.png"> 

### 3.2 结果分析
- 用户的密码集合为 `["password1", "password2", "password3", "password4"]`，服务器的泄露密码集合及标签为 `[("password1", 1), ("password3", 3), ("password4", 4), ("password6", 6)]`。
- 交集密码为 `"password1"`、`"password3"` 和 `"password4"`，对应的标签值分别为 1、3 和 4。
- 交集标签的总和为 `1 + 3 + 4 = 8`，与服务器解密得到的 `server.intersection_sum` 一致，验证了协议的正确性。

## 四、实验结论与心得
### 4.1 实验结论
通过本次实验，成功实现了 Google Password Checkup 协议。该协议能够有效地在保护用户和服务器隐私的前提下，计算出密码集合的交集大小以及交集中密码对应标签的总和。实验结果表明，协议能够正确地计算出交集标签的总和，验证了协议的正确性和可行性。

### 4.2 实验心得
- **对密码学技术的理解加深**：在实现过程中，进一步理解了 Diffie-Hellman 密钥交换和 Paillier 同态加密的原理和应用场景。
- **安全多方计算的实际应用**：深刻体会到安全多方计算在保护隐私方面的巨大潜力，尤其是在涉及多个参与方的数据分析场景中。

